name: Build and publish image, then trigger Harness

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT_ID: 069705096352
  AWS_ROLE_ARN: arn:aws:iam::069705096352:role/harness-demo-github-action-role
  AWS_REGION: us-east-1
  ECR_REPOSITORY: harness-demo-github-actions
  IMAGE_TAG: latest

jobs:
  build-publish-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-push
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="${REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

          docker build -f HarnessDemo/Dockerfile -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

          LATEST_URI="${REGISTRY}/${ECR_REPOSITORY}:latest"
          docker tag "$IMAGE_URI" "$LATEST_URI"
          docker push "$LATEST_URI"

          echo "{\"imageUri\":\"$IMAGE_URI\",\"tag\":\"$IMAGE_TAG\"}" > image-metadata.json

      - name: Upload image metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-metadata
          path: image-metadata.json

      - name: Trigger Harness deployment
        if: ${{ secrets.HARNESS_TRIGGER_URL != '' && secrets.HARNESS_API_KEY != '' }}
        env:
          HARNESS_TRIGGER_URL: ${{ secrets.HARNESS_TRIGGER_URL }}
          HARNESS_API_KEY: ${{ secrets.HARNESS_API_KEY }}
        run: |
          echo "Triggering Harness with IMAGE_URI=${IMAGE_URI}"

          curl -sS -X POST \
            -H "x-api-key: ${HARNESS_API_KEY}" \
            -H "content-type: application/json" \
            -d "{\"IMAGE_URI\":\"${IMAGE_URI}\"}" \
            "${HARNESS_TRIGGER_URL}"
